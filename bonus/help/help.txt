# To do
k3d cluster --k3s-arg "--disable=traefik@server:0"

Or find another solution cleaner 

# On install on yaml file 
prometheus:
    install: false

gitlab-runner:
    install: false

Install gitlab 

Helm gestionnaire de packets : 

# Install GitLab :
The GitLab Helm chart uses the Cloud Native GitLab (CNG) 
container images to deploy GitLab. Besides the CNG images 
for GitLab itself, the default configuration uses images 
published by third parties (for example, Bitnami) to deploy 
PostgreSQL, Redis, and MinIO to simplify non-production deployments.

# Prerequisites

Script qui install ca 
- kubectl
- helm 
- PostgreSQL
- Redis (in cluster)
- Gitaly (in cluster)

# 1. Docker (si pas déjà installé)
# 2. K3d
# 3. kubectl
# 4. Helm (indispensable pour GitLab)
# 5. GitLab Helm Chart (officiel)


✅ Créer le cluster K3d
✅ Installer GitLab
✅ Configurer Argo CD avec GitLab
✅ Cleanup

# Monitoring the deployment
helm status gitlab 

# Initial login 
kubectl get secret <name>-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode ; echo

# Argo cd 
argocd repo add https://github.com/argoproj/argocd-example-apps --username <username> --password <password>

# To have an example of values.yaml for gitlab 
helm show values gitlab/gitlab > tmp_values.yaml

helm uninstall gitlab -n gitlab 2>/dev/null || true
kubectl delete namespace gitlab 2>/dev/null || true
sleep 5
./install_gitlab.sh


# install gitlab 
helm uninstall gitlab -n gitlab 2>/dev/null || true
kubectl delete namespace gitlab 2>/dev/null || true
sleep 5

Launch script 
wait pods to be ready 
kubectl -n gitlab get pods -w



#1- Install 

# 2- setup_cluster 
Traefik is a ingress Controller. 


Next steps:
1. Add this to your /etc/hosts file:
   127.0.0.1 gitlab.local

2. Access GitLab at: http://gitlab.gitlab.local

3. Get initial root password:
   kubectl get secret -n gitlab gitlab-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode ; echo

4. Monitor deployment:
   kubectl -n gitlab get pods
   helm status gitlab -n gitlab


echo "127.0.0.1 gitlab.gitlab.local" | sudo tee -a /etc/hosts
curl http://gitlab.gitlab.local

Pour installer gitlab souci de mémoire :
sudo sync
sudo sysctl -w vm.drop_caches=3

==> a faire : ./setup_argocd_gitlab.sh

===============================================


clean apres setup_cluster :
k3d cluster list
k3d cluster stop iot-cluster
k3d cluster start iot-cluster